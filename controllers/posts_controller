const posts = require('../data/post_data.js');	

const index = (req,res)=>{

    //CON UN TAG PRECISO: ?tag=dolci (case-insensitive)
    /* const tag = req.query.tag;
    if (!tag) return res.json(posts);
    const filteredposts = posts.filter(post=>post.tags.some(t=>t.toLowerCase()===tag.toLowerCase()));
    res.json(filteredposts); */


    //CON PIU TAG:  ?tag=dolci&tag=ricette
    const { tag } = req.query;              //express unisce piu valori con stessa chiave in array

    if (!tag) return res.json(posts);       //controllo: se non esiste querystring restituisci tutto posts

    const alltags = (Array.isArray(tag)     //trasformo sempre in un array
                    ? tag
                    : [tag]) 
    .map(t => t.toLowerCase().trim());      //normalizzo querystring

    const results = posts.filter(p =>                       //restituisci solo i post dove
                    alltags.every(onetag =>                 //ogni tag nell'array di querystring
                    p.tags.some(t =>                        //(se c'è almeno una corrispondenza)
                    t.toLowerCase().includes(onetag))));    //è incluso(uguaglianza parziale) in una delle stringhe(tutto minuscolo) dell'array della proprità tags

    res.json(results);
}

const show = (req, res)=>{
	const id = Number(req.params.id); 
	if (isNaN(id)){return res.status(400).json({error:"Not valid request",message:"This request is not valid"})}
	const result = posts.find(post=>post.id===id);
	if(!result){return res.status(404).json({error:"Not Found",message:"Post not found"});}
	res.json(result);
}

const store = (req, res) => {
	res.send(`You requested to CREATE a new post`);
}

const update = (req, res) => {
	res.send(`You requested to UPDATE (full overwrite) the post with id: ${req.params.id}`);
}

const modify = (req, res) => {
	res.send(`You requested to MODIFY (partial) the post with id: ${req.params.id}`);
}

const destroy = (req, res) => {
    const id = Number(req.params.id); 
    const post = posts.find(post=>post.id===id);
    if (!post){
        res.status(404);
        return res.json({
            status:404,
            error:"Not Found",
            message:"Nessun post con questo id"
        })
    }
    posts.splice(posts.indexOf(post),1);
    console.log(posts);
	res.sendStatus(204);
}

module.exports = {index, show, store, update, modify, destroy};