const posts = require('../data/post_data.js');	

const index = (req,res)=>{

    //CON UN TAG PRECISO: ?tag=dolci (case-insensitive)
    /* const tag = req.query.tag;
    if (!tag) return res.json(posts);
    const filteredposts = posts.filter(post=>post.tags.some(t=>t.toLowerCase()===tag.toLowerCase()));
    res.json(filteredposts); */


    //CON PIU TAG:  ?tag=dolci&tag=ricette
    const { tag } = req.query;              //express unisce piu valori con stessa chiave in array

    if (!tag) return res.json(posts);       //controllo: se non esiste querystring restituisci tutto posts

    const alltags = (Array.isArray(tag)     //trasformo sempre in un array
                    ? tag
                    : [tag]) 
    .map(t => t.toLowerCase().trim());      //normalizzo querystring

    const results = posts.filter(p =>                       //restituisci solo i post dove
                    alltags.every(onetag =>                 //ogni tag nell'array di querystring
                    p.tags.some(t =>                        //(se c'è almeno una corrispondenza)
                    t.toLowerCase().includes(onetag))));    //è incluso(uguaglianza parziale) in una delle stringhe(tutto minuscolo) dell'array della proprità tags

    res.json(results);
}

const show = (req, res)=>{
	const id = Number(req.params.id); 
	if (isNaN(id)){return res.status(400).json({error:"Not valid request",message:"This request is not valid"})}
	const result = posts.find(post=>post.id===id);
	if(!result){return res.status(404).json({error:"Not Found",message:"Post not found"});}
	res.json(result);
}

const store = (req, res) => {

    console.log(req.body);                                          //req.body chiamata al server POST, invio Body Request in formato json
    const { title, content, image, tags } = req.body;                         //destructuring del json
    const maxId = posts.length  ? Math.max(...posts.map(p => p.id)) //recupero l'id piu alto nell'array di oggetti con Math.max
                                : 0;                                //se non ci sono post, l'id base è 0
    console.log("Id piu grande: "+maxId)

	const newPost = {           //creo un nuovo oggetto post da inserire nell'array
        id: maxId+1,            //aggiungo +1 all'id più grande dell'array (id univoco per ogni oggetto)
        title,                   //dichiaro le chiavi-valori 
        content,
        image,
        tags
    };
    console.log(newPost);

    posts.push(newPost);        //inserisco l'oggetto nel'array
    console.log(posts.length);  //dovrebbe restituire un oggetto in più

    res.status(201);            //status di nuovo oggetto creato con successo
    res.json(newPost);          //restituisco il nuovo oggetto in formato json
}

const update = (req, res) => {
	const id = Number(req.params.id); 
    if (isNaN(id)){return res.status(400).json({error:"Not valid request",message:"This request is not valid"})} 
    const post = posts.find(post=>post.id===id); 
    if(!post){return res.status(404).json({error:"Not Found",message:"Post not found"});} 

    //IL PUT SOSTITUISCE PER INTERO IL RECORD
    //ESEMPIO CON TUTTI I PARAMETRI OBBLIGATORI DA PASSARE O ERRORE
    const required = ["title", "content", "image", "tags"];             //parametri obbligatori
    const missing = required.filter(r => req.body[r] === undefined);    //se nella richiesta non è presente il parametro obbligatorio scrivilo in "missing"

    if (missing.length)                                     //se ci sono parametri mancanti
        { return res.status(400).json(                      //torna errore json
                { error: "Bad Request", 
                message: "Missing required parameters", 
                missing}                                    //parametri mancanti
        );} 
    
    const { title, content, image, tags } = req.body;       //destructuring del body request

    post.title = title; 
    post.content = content; 
    post.image = image; 
    post.tags = tags; 

    console.log(post); 
    res.status(200).json(post); 
}

const modify = (req, res) => {
    //recupero id come per show e restituisco errore se non trovo il post
	const id = Number(req.params.id); 
	if (isNaN(id)){return res.status(400).json({error:"Not valid request",message:"This request is not valid"})}
	const post = posts.find(post=>post.id===id);
	if(!post){return res.status(404).json({error:"Not Found",message:"Post not found"});}

    //destructuring del body request
    const { title, content, image, tags } = req.body;                         

	if (title) post.title = title;          //aggiorna valore se passato altrimenti rimane come prima
    if (content) post.content = content;    
    if (image) post.image = image;
    if (tags) post.tags = tags;         
    
    console.log(post);

    res.status(200);         //status OK
    res.json(post);          //restituisco il post aggiornato 
}

const destroy = (req, res) => {
    const id = Number(req.params.id); 
    const post = posts.find(post=>post.id===id);
    if (!post){
        res.status(404);
        return res.json({
            status:404,
            error:"Not Found",
            message:"Nessun post con questo id"
        })
    }
    posts.splice(posts.indexOf(post),1);
    console.log(posts);
	res.sendStatus(204);
}

module.exports = {index, show, store, update, modify, destroy};